name: Build Galleries

on:
  push:
    paths:
      - "assets/digital-photography/**"
      - "assets/photoshop/**"
      - ".github/workflows/build-galleries.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate galleries
        run: |
          python3 - <<'PY'
          import os, json

          galleries = {
            "assets/digital-photography": "Digital Photography",
            "assets/photoshop": "Photoshop"
          }

          exts = {".png", ".jpg", ".jpeg", ".webp", ".gif"}

          for folder in galleries:
            out = os.path.join(folder, "photos.json")
            os.makedirs(folder, exist_ok=True)
            files = []

            for name in os.listdir(folder):
              path = os.path.join(folder, name)
              if os.path.isfile(path):
                _, ext = os.path.splitext(name)
                if ext.lower() in exts and name != "photos.json":
                  files.append(name)

            files.sort(key=lambda s: s.lower())

            with open(out, "w", encoding="utf-8") as f:
              json.dump(files, f, indent=2)

            print(f"Wrote {out} with {len(files)} images.")
          PY

      - name: Commit photos.json files if changed
        run: |
          if git status --porcelain | grep -q "photos.json"; then
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add assets/**/photos.json
            git commit -m "Auto-update gallery photos.json files"
            git push
          else
            echo "No gallery updates needed."
          fi
